# データ設計書

## 文書情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | Multi-Mode Calculator |
| 文書バージョン | 1.0 |
| 作成日 | 2025-12-11 |
| 最終更新日 | 2025-12-11 |
| 作成者 | Claude Code |

---

## 1. 概要

本書では、Multi-Mode Calculatorで使用するデータ構造、LocalStorageスキーマ、および状態管理について定義する。

---

## 2. LocalStorageスキーマ

### 2.1 キー一覧

| キー名 | データ型 | デフォルト値 | 説明 |
|--------|---------|-------------|------|
| calc_theme | string | "default" | 選択中のテーマID |
| calc_darkMode | string | "false" | ダークモード有効/無効 |
| calc_lastMode | string | "standard" | 最後に使用した電卓モード |
| calc_angleMode | string | "DEG" | 角度モード（DEG/RAD） |
| calc_bitLength | string | "32" | ビット長（8/16/32/64） |
| calc_history | string (JSON) | "[]" | 計算履歴の配列 |

### 2.2 各キーの詳細

#### 2.2.1 calc_theme

```javascript
// 有効な値
const VALID_THEMES = [
  "default",   // Default - グレー基調
  "ocean",     // Ocean - 青・水色
  "forest",    // Forest - 緑・自然
  "sunset",    // Sunset - オレンジ・赤
  "midnight",  // Midnight - 紺・紫
  "cherry",    // Cherry - ピンク・桜色
  "mono",      // Monochrome - 白黒
  "neon",      // Neon - 蛍光色
  "wooden",    // Wooden - 木目調
  "glass"      // Glass - 透明感
];

// 読み込み例
const theme = localStorage.getItem('calc_theme') || 'default';
```

#### 2.2.2 calc_darkMode

```javascript
// 値: "true" または "false"（文字列）
// nullの場合はシステム設定に従う

// 読み込み例
const savedMode = localStorage.getItem('calc_darkMode');
if (savedMode === null) {
  // システム設定に従う
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  return prefersDark ? 'dark' : 'light';
}
return savedMode === 'true' ? 'dark' : 'light';
```

#### 2.2.3 calc_lastMode

```javascript
// 有効な値
const VALID_MODES = [
  "standard",    // 標準電卓
  "scientific",  // 関数電卓
  "programmer"   // プログラマ電卓
];

// 読み込み例
const lastMode = localStorage.getItem('calc_lastMode') || 'standard';
```

#### 2.2.4 calc_angleMode

```javascript
// 有効な値
const VALID_ANGLE_MODES = [
  "DEG",  // 度数法（degree）
  "RAD"   // ラジアン（radian）
];

// 読み込み例
const angleMode = localStorage.getItem('calc_angleMode') || 'DEG';
```

#### 2.2.5 calc_bitLength

```javascript
// 有効な値
const VALID_BIT_LENGTHS = [
  "8",   // BYTE
  "16",  // WORD
  "32",  // DWORD
  "64"   // QWORD
];

// 読み込み例
const bitLength = parseInt(localStorage.getItem('calc_bitLength') || '32');
```

#### 2.2.6 calc_history

```javascript
// JSON配列として保存
// 最大100件

// データ構造（1エントリ）
{
  "id": "hist_1702281600000_abc123def",  // 一意のID
  "expression": "10 + 5",                 // 計算式
  "result": "15",                         // 結果
  "mode": "standard",                     // 計算時のモード
  "timestamp": 1702281600000              // Unix時刻（ミリ秒）
}

// 読み込み例
function loadHistory() {
  try {
    const json = localStorage.getItem('calc_history');
    if (json) {
      const parsed = JSON.parse(json);
      if (Array.isArray(parsed)) {
        return parsed.slice(0, 100);  // 最大100件
      }
    }
  } catch (e) {
    console.error('Failed to load history:', e);
  }
  return [];
}
```

---

## 3. アプリケーション状態

### 3.1 Calculator State

```javascript
/**
 * 計算機の状態オブジェクト
 */
const calcState = {
  // 現在の入力値（文字列）
  // 例: "123.45", "FF", "1010"
  currentValue: '0',

  // 前回の値（演算子入力後に保持）
  // null: 初期状態または計算完了後
  previousValue: null,

  // 現在の演算子
  // null: 演算子未入力
  // 例: '+', '-', '×', '÷', 'AND', 'OR'
  currentOperator: null,

  // 電卓モード
  // 'standard' | 'scientific' | 'programmer'
  mode: 'standard',

  // 進数モード（プログラマ電卓）
  // 2 | 8 | 10 | 16
  base: 10,

  // ビット長（プログラマ電卓）
  // 8 | 16 | 32 | 64
  bitLength: 32,

  // 角度モード（関数電卓）
  // 'DEG' | 'RAD'
  angleMode: 'DEG',

  // メモリ値
  // 数値として保持
  memory: 0,

  // 計算結果表示フラグ
  // true: 次の数字入力で値をクリア
  isResultDisplayed: false,

  // エラー状態
  // true: エラー表示中（次の入力でクリア）
  hasError: false,

  // 式の履歴（サブディスプレイ用）
  // 例: "10 + 5 ="
  expression: ''
};
```

### 3.2 History Entry

```javascript
/**
 * 履歴エントリの型定義
 * @typedef {Object} HistoryEntry
 */
const historyEntrySchema = {
  // 一意のID（タイムスタンプ + ランダム文字列）
  id: 'string',

  // 計算式
  // 例: "10 + 5", "sin(45)", "FF AND 0F"
  expression: 'string',

  // 計算結果
  // 例: "15", "0.7071", "F"
  result: 'string',

  // 計算時の電卓モード
  // 'standard' | 'scientific' | 'programmer'
  mode: 'string',

  // 作成日時（Unixタイムスタンプ、ミリ秒）
  timestamp: 'number'
};
```

### 3.3 Theme State

```javascript
/**
 * テーマモジュールの状態
 */
const themeState = {
  // 現在のテーマID
  currentTheme: 'default',

  // 現在のモード
  // 'light' | 'dark'
  currentMode: 'light',

  // ダイアログ表示状態
  isDialogOpen: false,

  // システムのダークモード設定
  systemPrefersDark: false
};
```

### 3.4 History State

```javascript
/**
 * 履歴モジュールの状態
 */
const historyState = {
  // 履歴エントリの配列
  // 新しいものが先頭
  entries: [],

  // パネル表示状態
  isPanelOpen: false
};
```

---

## 4. データ制限

### 4.1 数値制限

| 項目 | 制限値 | 理由 |
|------|--------|------|
| 最大表示桁数 | 16桁 | IEEE 754倍精度の有効桁数 |
| 最大小数桁数 | 10桁 | 表示の見やすさ |
| 階乗最大値 | 170 | 171!はInfinity |
| ビット演算最大値 | 2^64-1 | QWORDモードの上限 |

### 4.2 履歴制限

| 項目 | 制限値 | 理由 |
|------|--------|------|
| 最大履歴件数 | 100件 | LocalStorageサイズ考慮 |
| 式の最大表示長 | 50文字 | UI表示の都合 |

### 4.3 LocalStorage制限

| 項目 | 目安 |
|------|------|
| 1キーあたり | 約5KB以内 |
| 合計 | 約50KB以内（余裕を持たせる） |

### 4.4 LocalStorage容量超過時の処理（M-05対応）

LocalStorageへの書き込みが失敗した場合（QuotaExceededError）の対処方針：

#### 4.4.1 検出方法

```javascript
/**
 * LocalStorageへの安全な書き込み
 * @param {string} key - キー名
 * @param {string} value - 保存する値
 * @returns {boolean} 保存成功/失敗
 */
function safeSetItem(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch (e) {
    if (e.name === 'QuotaExceededError' || e.code === 22) {
      console.error('LocalStorage quota exceeded:', key);
      return false;
    }
    throw e;
  }
}
```

#### 4.4.2 容量超過時の対処

| 対象データ | 対処方法 |
|-----------|----------|
| calc_history | 古い履歴を削除して再試行（最大50件まで削減） |
| calc_theme | 保存失敗を無視（メモリ上の値で動作継続） |
| calc_darkMode | 保存失敗を無視（メモリ上の値で動作継続） |
| calc_lastMode | 保存失敗を無視（次回起動時はデフォルト値） |
| calc_angleMode | 保存失敗を無視（メモリ上の値で動作継続） |
| calc_bitLength | 保存失敗を無視（メモリ上の値で動作継続） |

#### 4.4.3 履歴の容量削減処理

```javascript
/**
 * 履歴を保存（容量超過時は古いエントリを削除）
 * @param {Array} history - 履歴配列
 * @returns {boolean} 保存成功/失敗
 */
function saveHistoryWithFallback(history) {
  // まず通常の保存を試行
  const json = JSON.stringify(history);
  if (safeSetItem('calc_history', json)) {
    return true;
  }

  // 容量超過の場合、段階的に古い履歴を削除
  const reductionSteps = [75, 50, 25, 10];

  for (const maxEntries of reductionSteps) {
    const reduced = history.slice(0, maxEntries);
    const reducedJson = JSON.stringify(reduced);

    if (safeSetItem('calc_history', reducedJson)) {
      console.warn(`History reduced to ${maxEntries} entries due to storage limit`);
      return true;
    }
  }

  // 全て失敗した場合は履歴をクリア
  try {
    localStorage.removeItem('calc_history');
    console.error('History cleared due to storage limit');
  } catch (e) {
    // 削除も失敗した場合は無視
  }

  return false;
}
```

#### 4.4.4 ユーザー通知

- 容量超過による履歴削減が発生した場合、コンソールに警告を出力
- 致命的なエラーではないため、ユーザーへのモーダル表示は行わない
- 機能は継続して動作し、メモリ上のデータは保持される

---

## 5. データバリデーション

### 5.1 入力値検証

```javascript
/**
 * 数字入力の検証
 * @param {string} input - 入力文字
 * @param {number} base - 現在の進数
 * @returns {boolean} 有効な入力かどうか
 */
function isValidDigit(input, base) {
  if (base === 2) {
    return /^[01]$/.test(input);
  }
  if (base === 8) {
    return /^[0-7]$/.test(input);
  }
  if (base === 10) {
    return /^[0-9]$/.test(input);
  }
  if (base === 16) {
    return /^[0-9A-Fa-f]$/.test(input);
  }
  return false;
}
```

### 5.2 計算結果検証

```javascript
/**
 * 計算結果の検証
 * @param {number} result - 計算結果
 * @returns {Object} { valid: boolean, error: string|null }
 */
function validateResult(result) {
  if (isNaN(result)) {
    return { valid: false, error: 'Error' };
  }
  if (!isFinite(result)) {
    return { valid: false, error: 'Infinity' };
  }
  return { valid: true, error: null };
}
```

### 5.3 LocalStorageデータ検証

```javascript
/**
 * LocalStorageから読み込んだデータの検証
 * @param {string} key - キー名
 * @param {string} value - 読み込んだ値
 * @returns {boolean} 有効なデータかどうか
 */
function validateStorageData(key, value) {
  switch (key) {
    case 'calc_theme':
      return VALID_THEMES.includes(value);
    case 'calc_darkMode':
      return value === 'true' || value === 'false';
    case 'calc_lastMode':
      return VALID_MODES.includes(value);
    case 'calc_angleMode':
      return VALID_ANGLE_MODES.includes(value);
    case 'calc_bitLength':
      return VALID_BIT_LENGTHS.includes(value);
    case 'calc_history':
      try {
        const arr = JSON.parse(value);
        return Array.isArray(arr);
      } catch {
        return false;
      }
    default:
      return false;
  }
}
```

---

## 6. データフロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                        ユーザー入力                              │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        main.js                                  │
│                    イベント検知・振り分け                        │
└─────────────────────────────┬───────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  calculator.js  │ │   themes.js     │ │   history.js    │
│                 │ │                 │ │                 │
│  calcState      │ │  themeState     │ │  historyState   │
│  ・currentValue │ │  ・currentTheme │ │  ・entries      │
│  ・previousValue│ │  ・currentMode  │ │  ・isPanelOpen  │
│  ・operator     │ │  ・isDialogOpen │ │                 │
│  ・mode/base    │ │                 │ │                 │
└────────┬────────┘ └────────┬────────┘ └────────┬────────┘
         │                   │                   │
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                        display.js                               │
│                     表示更新・フォーマット                       │
└─────────────────────────────────────────────────────────────────┘
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                        LocalStorage                             │
│  calc_theme, calc_darkMode, calc_lastMode, calc_history, ...    │
└─────────────────────────────────────────────────────────────────┘
```

---

## 7. マイグレーション方針

将来のバージョンでデータ構造が変更される場合の方針：

1. **バージョン管理**
   - `calc_version` キーでスキーマバージョンを管理
   - 読み込み時にバージョンチェック

2. **下位互換性**
   - 古いデータは新しい形式に自動変換
   - 変換できない場合はデフォルト値を使用

3. **データ移行例**
```javascript
function migrateData() {
  const version = localStorage.getItem('calc_version');

  if (!version || version < '2.0') {
    // v1.0 → v2.0 のマイグレーション
    // 例: 履歴のスキーマ変更
  }

  localStorage.setItem('calc_version', '2.0');
}
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | 初版作成 | Claude Code |
| 2025-12-11 | 1.1 | M-05対応: LocalStorage容量超過時の処理を追加（4.4章） | Claude Code |
