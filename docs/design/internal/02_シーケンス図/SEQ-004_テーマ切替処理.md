# SEQ-004 ãƒ†ãƒ¼ãƒåˆ‡æ›¿å‡¦ç†ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

## æ–‡æ›¸æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ID | SEQ-004 |
| å‡¦ç†å | ãƒ†ãƒ¼ãƒãƒ»ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿å‡¦ç† |
| å¯¾å¿œç”»é¢ | SCR-005ï¼ˆãƒ†ãƒ¼ãƒè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰ |
| ä½œæˆæ—¥ | 2025-12-11 |

---

## 1. æ¦‚è¦

ãƒ†ãƒ¼ãƒè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ã®ãƒ†ãƒ¼ãƒå¤‰æ›´ãŠã‚ˆã³ãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’ç¤ºã™ã€‚

---

## 2. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆãƒ†ãƒ¼ãƒå¤‰æ›´ï¼‰

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant T as themes.js
    participant D as DOM
    participant LS as LocalStorage

    U->>M: ã‚¯ãƒªãƒƒã‚¯: è¨­å®šãƒœã‚¿ãƒ³
    M->>T: openDialog()
    T->>D: dialog.classList.add("is-open")
    T->>D: dialog.setAttribute("aria-hidden", "false")
    T->>T: isDialogOpen = true

    Note over U,LS: ãƒ†ãƒ¼ãƒé¸æŠ

    U->>T: ã‚¯ãƒªãƒƒã‚¯: "Ocean"ãƒ†ãƒ¼ãƒ
    T->>T: handleThemeClick(event)
    T->>T: theme = event.target.dataset.theme â†’ "ocean"
    T->>T: setTheme("ocean")
    T->>T: currentTheme = "ocean"
    T->>D: document.documentElement.setAttribute("data-theme", "ocean")
    T->>LS: setItem("calc_theme", "ocean")
    T->>T: updateThemeSelection()
    T->>D: å‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è§£é™¤
    T->>D: "Ocean"ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š

    Note over D: CSSå¤‰æ•°ãŒå³åº§ã«åæ˜ ã•ã‚Œã€UIã®è‰²ãŒå¤‰åŒ–
```

---

## 3. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆãƒ©ã‚¤ãƒˆ/ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼‰

```mermaid
sequenceDiagram
    participant U as User
    participant T as themes.js
    participant D as DOM
    participant LS as LocalStorage

    Note over U,LS: å‰æ: ç¾åœ¨ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰

    U->>T: ã‚¯ãƒªãƒƒã‚¯: ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ï¼ˆğŸŒ™ï¼‰
    T->>T: toggleMode()
    T->>T: newMode = "dark" (ç¾åœ¨ãŒlightãªã®ã§)
    T->>T: setMode("dark")
    T->>T: currentMode = "dark"
    T->>D: document.documentElement.setAttribute("data-mode", "dark")
    T->>LS: setItem("calc_darkMode", "true")
    T->>T: updateModeToggle()
    T->>D: ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ â˜€ ã«å¤‰æ›´
    T->>D: aria-label ã‚’ "ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ" ã«å¤‰æ›´

    Note over D: ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®CSSå¤‰æ•°ãŒé©ç”¨
```

---

## 4. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆåˆæœŸåŒ–æ™‚ã®ã‚·ã‚¹ãƒ†ãƒ è¨­å®šæ¤œå‡ºï¼‰

```mermaid
sequenceDiagram
    participant B as Browser
    participant T as themes.js
    participant D as DOM
    participant LS as LocalStorage

    Note over B,LS: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚

    T->>T: init()
    T->>B: window.matchMedia("(prefers-color-scheme: dark)")
    B->>T: mediaQuery.matches = true (ã‚·ã‚¹ãƒ†ãƒ ãŒãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰)
    T->>T: systemPrefersDark = true

    T->>LS: getItem("calc_darkMode")
    LS->>T: null (ä¿å­˜ãªã—)

    T->>T: LocalStorageã«ä¿å­˜ãŒãªã„ã®ã§ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†
    T->>T: currentMode = "dark"
    T->>D: setAttribute("data-mode", "dark")

    Note over T,LS: ã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´ã®ç›£è¦–ã‚’é–‹å§‹

    T->>B: mediaQuery.addEventListener("change", handler)
```

---

## 5. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šå¤‰æ›´ã®è‡ªå‹•è¿½å¾“ï¼‰

```mermaid
sequenceDiagram
    participant OS as OS/Browser
    participant B as MediaQuery
    participant T as themes.js
    participant D as DOM

    Note over OS,D: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒOSã®ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’å¤‰æ›´

    OS->>B: ã‚·ã‚¹ãƒ†ãƒ ãƒ†ãƒ¼ãƒãŒãƒ€ãƒ¼ã‚¯ã«å¤‰æ›´
    B->>T: change event (matches = true)
    T->>T: systemPrefersDark = true

    T->>T: LocalStorageã«æ˜ç¤ºçš„ãªè¨­å®šãŒã‚ã‚‹ã‹ç¢ºèª
    alt æ˜ç¤ºçš„ãªè¨­å®šãªã—
        T->>T: setMode("dark")
        T->>D: setAttribute("data-mode", "dark")
    else æ˜ç¤ºçš„ãªè¨­å®šã‚ã‚Š
        T->>T: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ç¶­æŒï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
    end
```

---

## 6. ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹ï¼‰

```mermaid
sequenceDiagram
    participant U as User
    participant T as themes.js
    participant D as DOM

    alt é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
        U->>T: ã‚¯ãƒªãƒƒã‚¯: é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ (Ã—)
        T->>T: closeDialog()
    else ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ã‚¯ãƒªãƒƒã‚¯
        U->>T: ã‚¯ãƒªãƒƒã‚¯: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°å¤–ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
        T->>T: handleOverlayClick(event)
        T->>T: event.target === dialog â†’ true
        T->>T: closeDialog()
    else Escapeã‚­ãƒ¼ã‚’æŠ¼ä¸‹
        U->>T: ã‚­ãƒ¼æŠ¼ä¸‹: Escape
        T->>T: handleKeydown(event)
        T->>T: event.key === "Escape" && isDialogOpen
        T->>T: closeDialog()
    end

    T->>D: dialog.classList.remove("is-open")
    T->>D: dialog.setAttribute("aria-hidden", "true")
    T->>T: isDialogOpen = false
```

---

## 7. CSSå¤‰æ•°ã®é©ç”¨ãƒ•ãƒ­ãƒ¼

```
setTheme("ocean") + setMode("dark")
    â”‚
    â–¼
document.documentElement
    â”‚
    â”œâ”€â–º data-theme="ocean"
    â””â”€â–º data-mode="dark"
    â”‚
    â–¼
CSSã‚»ãƒ¬ã‚¯ã‚¿ãŒãƒãƒƒãƒ
:root[data-theme="ocean"][data-mode="dark"]
    â”‚
    â–¼
CSSå¤‰æ•°ãŒé©ç”¨
    --color-bg-primary: #0a192f;
    --color-bg-secondary: #112240;
    --color-text-primary: #e6f1ff;
    --color-accent: #64ffda;
    ...
    â”‚
    â–¼
å…¨UIè¦ç´ ãŒå³åº§ã«æ›´æ–°ï¼ˆå†æç”»ä¸è¦ï¼‰
```

---

## 8. å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆinitï¼‰

```
ThemeManager.init()
    â”‚
    â”œâ”€â–º cacheElements()
    â”‚     DOMè¦ç´ ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    â”‚
    â”œâ”€â–º detectSystemPreference()
    â”‚     â”œâ”€â–º matchMedia("(prefers-color-scheme: dark)")
    â”‚     â””â”€â–º addEventListener ã§å¤‰æ›´ã‚’ç›£è¦–
    â”‚
    â”œâ”€â–º loadFromStorage()
    â”‚     â”œâ”€â–º getItem("calc_theme") â†’ ãƒ†ãƒ¼ãƒã‚’å¾©å…ƒ
    â”‚     â””â”€â–º getItem("calc_darkMode") â†’ ãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
    â”‚           â””â”€â–º ä¿å­˜ãªã— â†’ ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«å¾“ã†
    â”‚
    â”œâ”€â–º setupEventListeners()
    â”‚     â”œâ”€â–º ãƒ¢ãƒ¼ãƒ‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
    â”‚     â”œâ”€â–º é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    â”‚     â”œâ”€â–º ãƒ†ãƒ¼ãƒãƒªã‚¹ãƒˆã‚¯ãƒªãƒƒã‚¯
    â”‚     â””â”€â–º ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯
    â”‚
    â”œâ”€â–º applyTheme()
    â”‚     â””â”€â–º setAttribute("data-theme", ...)
    â”‚
    â”œâ”€â–º applyMode()
    â”‚     â””â”€â–º setAttribute("data-mode", ...)
    â”‚
    â””â”€â–º renderThemeList()
          â””â”€â–º å„ãƒ†ãƒ¼ãƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’æç”»
```

---

## 9. ãƒ†ãƒ¼ãƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä»•çµ„ã¿

```mermaid
sequenceDiagram
    participant T as themes.js
    participant D as DOM

    T->>D: renderThemeItem("ocean")

    D->>D: div.theme-item ã‚’ä½œæˆ
    D->>D: div.theme-item__preview ã‚’ä½œæˆ
    D->>D: preview.setAttribute("data-theme", "ocean")

    Note over D: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦ç´ ã®ã¿ã«<br/>data-theme="ocean"ãŒé©ç”¨ã•ã‚Œ<br/>ãã®è¦ç´ å†…ã§oceanãƒ†ãƒ¼ãƒã®<br/>è‰²ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

CSSå´ã®å¯¾å¿œï¼š
```css
.theme-item__preview[data-theme="ocean"] {
  --preview-bg: #1a365d;
  --preview-accent: #4299e1;
  background: var(--preview-bg);
}

.theme-item__preview[data-theme="ocean"]::before {
  background: var(--preview-accent);
}
```

---

## å¤‰æ›´å±¥æ­´

| æ—¥ä»˜ | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | å¤‰æ›´å†…å®¹ | å¤‰æ›´è€… |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | åˆç‰ˆä½œæˆ | Claude Code |
