# SEQ-003 進数変換処理シーケンス図

## 文書情報

| 項目 | 内容 |
|------|------|
| シーケンスID | SEQ-003 |
| 処理名 | 進数変換・ビット演算処理 |
| 対応画面 | SCR-003（プログラマ電卓） |
| 作成日 | 2025-12-11 |

---

## 1. 概要

プログラマ電卓モードでの進数切り替え、ビット演算、ASCII変換の処理フローを示す。

---

## 2. シーケンス図（進数切り替え）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant LS as LocalStorage

    Note over U,LS: 前提: DECモード、currentValue = "255"

    U->>M: クリック: "HEX"ボタン
    M->>C: setBase(16)
    C->>C: 現在の値を10進数として保持
    C->>C: base = 16
    C->>C: currentValue = convertBase("255", 10, 16) → "FF"
    C->>LS: setItem("calc_base", "16")
    C->>D: update()
    D->>D: updateMainDisplay("FF")
    D->>D: updateBaseDisplays()
    D-->>D: HEX: "FF" (active)
    D-->>D: DEC: "255"
    D-->>D: OCT: "377"
    D-->>D: BIN: "1111 1111"
    D->>D: updateBitPanel()
    D->>D: updateBaseModeIndicator("HEX")
```

---

## 3. シーケンス図（16進数入力）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 前提: HEXモード、currentValue = "A"

    U->>M: クリック: ボタン "B"
    M->>C: inputHexDigit("B")
    C->>C: isValidForBase("B", 16) → true
    C->>C: currentValue = "AB"
    C->>D: update()
    D->>D: updateMainDisplay("AB")
    D->>D: updateBaseDisplays()
    D-->>D: HEX: "AB"
    D-->>D: DEC: "171"
    D-->>D: OCT: "253"
    D-->>D: BIN: "1010 1011"
```

---

## 4. シーケンス図（ビット演算 - NOT）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 前提: DECモード、32bit、currentValue = "255"

    U->>M: クリック: ボタン "NOT"
    M->>C: bitwiseOperation("NOT")
    C->>C: value = 255 (0x000000FF)
    C->>C: mask = 0xFFFFFFFF (32bit)
    C->>C: result = (~255) & mask
    C->>C: result = 0xFFFFFF00 = 4294967040
    C->>C: currentValue = "4294967040"
    C->>D: update()
    D->>D: updateMainDisplay("4,294,967,040")
    D->>D: updateBitPanel()
    Note over D: ビットパネル: 11111111 11111111 11111111 00000000
```

---

## 5. シーケンス図（ビット演算 - AND）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 0xFF AND 0x0F を計算

    U->>M: 入力: "FF" (HEXモード)
    M->>C: inputHexDigit("F"), inputHexDigit("F")
    C->>C: currentValue = "FF"
    C->>D: update()

    U->>M: クリック: ボタン "AND"
    M->>C: bitwiseOperation("AND")
    C->>C: previousValue = 255
    C->>C: currentOperator = "AND"
    C->>D: update()

    U->>M: 入力: "0F"
    M->>C: inputNumber("0"), inputHexDigit("F")
    C->>C: currentValue = "0F"
    C->>D: update()

    U->>M: クリック: ボタン "="
    M->>C: calculate()
    C->>C: a = 255 (0xFF)
    C->>C: b = 15 (0x0F)
    C->>C: result = 255 & 15 = 15 (0x0F)
    C->>C: currentValue = "F"
    C->>D: update()
    D->>D: updateMainDisplay("F")
```

---

## 6. シーケンス図（ビット長変更）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant LS as LocalStorage

    Note over U,LS: 前提: 32bit(DWORD)、currentValue = "FFFFFFFF" (4294967295)

    U->>M: クリック: "WORD"ボタン
    M->>C: setBitLength(16)
    C->>C: bitLength = 16
    C->>C: mask = 0xFFFF
    C->>C: currentValue = clampTobitLength(4294967295)
    C->>C: currentValue = 4294967295 & 0xFFFF = 65535 → "FFFF"
    C->>LS: setItem("calc_bitLength", "16")
    C->>D: update()
    D->>D: updateMainDisplay("FFFF")
    D->>D: updateBitPanel()
    Note over D: ビットパネルは16ビット表示に変更
```

---

## 7. シーケンス図（ASCII変換）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: HEX→ASCII変換ダイアログ

    U->>M: ASCII変換ダイアログを開く
    M->>M: openAsciiDialog()

    U->>M: 入力: "48 65 6C 6C 6F"
    U->>M: クリック: "変換"ボタン

    M->>C: hexToAscii("48 65 6C 6C 6F")
    C->>C: cleanHex = "48656C6C6F"
    C->>C: 2文字ずつ分割: ["48","65","6C","6C","6F"]
    C->>C: 各バイトをASCII文字に変換
    C-->>C: 0x48 → "H"
    C-->>C: 0x65 → "e"
    C-->>C: 0x6C → "l"
    C-->>C: 0x6C → "l"
    C-->>C: 0x6F → "o"
    C->>M: { success: true, value: "Hello" }

    M->>D: 出力エリアに"Hello"を表示
```

---

## 8. シーケンス図（ASCII→HEX変換）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: ASCII→HEX変換ダイアログ

    U->>M: モード切替: "ASCII→HEX"
    U->>M: 入力: "Hello"
    U->>M: クリック: "変換"ボタン

    M->>C: asciiToHex("Hello")
    C->>C: 各文字のコードポイントを取得
    C-->>C: "H" → 72 → "48"
    C-->>C: "e" → 101 → "65"
    C-->>C: "l" → 108 → "6C"
    C-->>C: "l" → 108 → "6C"
    C-->>C: "o" → 111 → "6F"
    C->>C: スペース区切りで結合
    C->>M: { success: true, value: "48 65 6C 6C 6F" }

    M->>D: 出力エリアに"48 65 6C 6C 6F"を表示
```

---

## 9. エラーケース

### 9.1 無効な16進数入力

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: HEXモードで "G" を入力しようとした場合

    U->>C: inputHexDigit("G")
    C->>C: isValidForBase("G", 16) → false
    C->>C: 入力を無視（return）
    Note over D: 表示は変化なし
```

### 9.2 進数モードで無効な数字

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: OCTモードで "9" を入力しようとした場合

    U->>C: inputNumber("9")
    C->>C: isValidForBase("9", 8) → false (9 >= 8)
    C->>C: 入力を無視（return）
    Note over D: 表示は変化なし
```

### 9.3 ASCII変換エラー

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 無効なHEX入力

    U->>M: 入力: "ZZ XX"
    U->>M: クリック: "変換"ボタン

    M->>C: hexToAscii("ZZ XX")
    C->>C: 正規表現チェック: /^[0-9A-Fa-f]+$/
    C->>C: "ZZXX" → チェック失敗
    C->>M: { success: false, error: "ERR-ASC-001" }

    M->>D: エラーメッセージ表示
    D->>D: "無効な16進数が含まれています"
```

---

## 10. 処理フロー（進数変換）

```
setBase(newBase)
    │
    ├─► 現在の値を10進数に変換
    │     value = parseInt(currentValue, currentBase)
    │
    ├─► base = newBase
    │
    ├─► 新しい進数で文字列化
    │     currentValue = value.toString(newBase).toUpperCase()
    │
    ├─► LocalStorageに保存
    │
    └─► DisplayManager.update()
          ├─► updateMainDisplay()
          ├─► updateBaseDisplays()
          ├─► updateBitPanel()
          └─► updateBaseModeIndicator()
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | 初版作成 | Claude Code |
