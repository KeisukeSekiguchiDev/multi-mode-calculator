# SEQ-001 基本計算処理シーケンス図

## 文書情報

| 項目 | 内容 |
|------|------|
| シーケンスID | SEQ-001 |
| 処理名 | 基本計算処理（四則演算） |
| 対応画面 | SCR-001（標準電卓） |
| 作成日 | 2025-12-11 |

---

## 1. 概要

ユーザーが「10 + 5 =」のような基本的な四則演算を行う際の処理フローを示す。

---

## 2. シーケンス図

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant H as history.js
    participant LS as LocalStorage

    Note over U,LS: 数字入力フェーズ（"10"を入力）

    U->>M: クリック: ボタン "1"
    M->>C: inputNumber("1")
    C->>C: currentValue = "1"
    C->>D: update()
    D->>D: updateMainDisplay("1")

    U->>M: クリック: ボタン "0"
    M->>C: inputNumber("0")
    C->>C: currentValue = "10"
    C->>D: update()
    D->>D: updateMainDisplay("10")

    Note over U,LS: 演算子入力フェーズ

    U->>M: クリック: ボタン "+"
    M->>C: inputOperator("+")
    C->>C: previousValue = 10
    C->>C: currentOperator = "+"
    C->>C: expression = "10 +"
    C->>D: update()
    D->>D: updateMainDisplay("10")
    D->>D: updateSubDisplay("10 +")

    Note over U,LS: 第2オペランド入力フェーズ

    U->>M: クリック: ボタン "5"
    M->>C: inputNumber("5")
    C->>C: currentValue = "5"
    C->>D: update()
    D->>D: updateMainDisplay("5")
    D->>D: updateSubDisplay("10 +")

    Note over U,LS: 計算実行フェーズ

    U->>M: クリック: ボタン "="
    M->>C: calculate()
    C->>C: performOperation(10, "+", 5)
    C->>C: result = 15
    C->>H: add({expression: "10 + 5", result: "15", mode: "standard"})
    H->>LS: setItem("calc_history", [...])
    C->>C: currentValue = "15"
    C->>C: リセット: previousValue, currentOperator
    C->>D: update()
    D->>D: updateMainDisplay("15")
    D->>D: updateSubDisplay("")
```

---

## 3. 処理ステップ詳細

### 3.1 数字入力

| ステップ | 処理内容 | 状態変化 |
|---------|---------|---------|
| 1 | ユーザーがボタン"1"をクリック | - |
| 2 | イベントデリゲーションでmain.jsが検知 | - |
| 3 | calculator.inputNumber("1")を呼び出し | currentValue: "0" → "1" |
| 4 | display.update()で表示更新 | 表示: "1" |
| 5 | ユーザーがボタン"0"をクリック | - |
| 6 | calculator.inputNumber("0")を呼び出し | currentValue: "1" → "10" |
| 7 | display.update()で表示更新 | 表示: "10" |

### 3.2 演算子入力

| ステップ | 処理内容 | 状態変化 |
|---------|---------|---------|
| 1 | ユーザーがボタン"+"をクリック | - |
| 2 | calculator.inputOperator("+")を呼び出し | previousValue: null → 10 |
| 3 | 現在の値を保存 | currentOperator: null → "+" |
| 4 | 式を構築 | expression: "" → "10 +" |
| 5 | 結果表示フラグを設定 | isResultDisplayed: true |
| 6 | display.update()で表示更新 | サブ表示: "10 +" |

### 3.3 計算実行

| ステップ | 処理内容 | 状態変化 |
|---------|---------|---------|
| 1 | ユーザーがボタン"="をクリック | - |
| 2 | calculator.calculate()を呼び出し | - |
| 3 | performOperation(10, "+", 5)で計算 | result = 15 |
| 4 | 結果の検証（Infinity, NaNチェック） | - |
| 5 | history.add()で履歴に追加 | 履歴に追加 |
| 6 | LocalStorageに保存 | calc_history更新 |
| 7 | 状態をリセット | previousValue: null, currentOperator: null |
| 8 | display.update()で表示更新 | 表示: "15" |

---

## 4. エラーケース

### 4.1 ゼロ除算

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    U->>C: calculate() [10 ÷ 0]
    C->>C: performOperation(10, "÷", 0)
    C->>C: result = NaN (ゼロ除算)
    C->>C: setError("Error")
    C->>C: hasError = true
    C->>D: update()
    D->>D: updateMainDisplay("Error")
```

### 4.2 桁数超過

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 16桁入力済みの状態
    U->>C: inputNumber("7")
    C->>C: 桁数チェック: 16 >= MAX_DIGITS
    C->>C: 入力を無視（return）
    Note over D: 表示は変化なし
```

---

## 5. 関連シーケンス

| シーケンスID | 処理名 | 関係 |
|-------------|--------|------|
| SEQ-002 | 関数計算処理 | 派生 |
| SEQ-003 | 進数変換処理 | 派生 |
| SEQ-004 | 履歴操作 | 連携 |

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | 初版作成 | Claude Code |
