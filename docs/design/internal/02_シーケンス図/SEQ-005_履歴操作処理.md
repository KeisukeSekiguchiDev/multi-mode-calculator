# SEQ-005 履歴操作処理シーケンス図

## 文書情報

| 項目 | 内容 |
|------|------|
| シーケンスID | SEQ-005 |
| 処理名 | 履歴の表示・操作処理 |
| 対応画面 | SCR-004（履歴パネル） |
| 作成日 | 2025-12-11 |

---

## 1. 概要

計算履歴パネルの表示、履歴項目の選択、削除などの操作フローを示す。

---

## 2. シーケンス図（履歴パネルを開く）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant H as history.js
    participant D as DOM
    participant LS as LocalStorage

    U->>M: クリック: 履歴ボタン
    M->>H: openPanel()
    H->>D: panel.classList.add("is-open")
    H->>D: panel.setAttribute("aria-hidden", "false")
    H->>H: isPanelOpen = true
    H->>H: render()

    H->>H: entries.length > 0 ?
    alt 履歴あり
        H->>D: hideEmptyMessage()
        loop 各履歴エントリ
            H->>H: renderEntry(entry)
            H->>D: list.appendChild(entryElement)
        end
    else 履歴なし
        H->>D: showEmptyMessage()
        H->>D: 「履歴がありません」を表示
    end

    H->>D: firstFocusable.focus()
```

---

## 3. シーケンス図（履歴項目をクリック）

```mermaid
sequenceDiagram
    participant U as User
    participant H as history.js
    participant C as calculator.js
    participant D as display.js

    Note over U,D: 履歴項目「10 + 5 = 15」をクリック

    U->>H: クリック: 履歴項目
    H->>H: handleListClick(event)
    H->>H: item = event.target.closest(".history__item")
    H->>H: entry = get(item.dataset.id)
    H->>H: entry.result = "15"

    H->>C: setCurrentValue("15")
    C->>C: currentValue = "15"
    C->>C: previousValue = null
    C->>C: currentOperator = null
    C->>C: isResultDisplayed = true

    H->>D: update()
    D->>D: updateMainDisplay("15")

    H->>H: closePanel()
    H->>D: panel.classList.remove("is-open")
```

---

## 4. シーケンス図（履歴項目をコピー）

```mermaid
sequenceDiagram
    participant U as User
    participant H as history.js
    participant CB as Clipboard API
    participant D as DOM

    U->>H: クリック: コピーボタン
    H->>H: handleListClick(event)
    H->>H: target.dataset.action === "copy"
    H->>H: value = target.dataset.value → "15"

    H->>CB: navigator.clipboard.writeText("15")
    CB->>H: Promise resolved

    H->>H: showToast("コピーしました")
    H->>D: トースト要素を作成
    H->>D: document.body.appendChild(toast)
    H->>D: toast.classList.add("toast--show")

    Note over D: 2秒後

    H->>D: toast.classList.remove("toast--show")
    H->>D: toast.remove()
```

---

## 5. シーケンス図（履歴項目を削除）

```mermaid
sequenceDiagram
    participant U as User
    participant H as history.js
    participant D as DOM
    participant LS as LocalStorage

    U->>H: クリック: 削除ボタン (×)
    H->>H: handleListClick(event)
    H->>H: target.dataset.action === "delete"
    H->>H: item = target.closest(".history__item")
    H->>H: id = item.dataset.id

    H->>H: remove(id)
    H->>H: entries = entries.filter(e => e.id !== id)
    H->>LS: setItem("calc_history", JSON.stringify(entries))

    H->>H: render()
    H->>D: リストを再描画
```

---

## 6. シーケンス図（全履歴をクリア）

```mermaid
sequenceDiagram
    participant U as User
    participant H as history.js
    participant B as Browser
    participant D as DOM
    participant LS as LocalStorage

    U->>H: クリック: 「履歴をクリア」ボタン
    H->>H: handleClearClick()

    H->>B: confirm("履歴をすべて削除しますか？")
    B->>U: 確認ダイアログを表示

    alt ユーザーが「はい」を選択
        U->>B: OK
        B->>H: true

        H->>H: clear()
        H->>H: entries = []
        H->>LS: setItem("calc_history", "[]")

        H->>H: render()
        H->>D: showEmptyMessage()
        H->>D: 「履歴がありません」を表示

        H->>H: showToast("履歴を削除しました")
        H->>D: トースト表示

    else ユーザーが「いいえ」を選択
        U->>B: Cancel
        B->>H: false
        Note over H: 何もしない
    end
```

---

## 7. シーケンス図（計算結果の履歴追加）

```mermaid
sequenceDiagram
    participant C as calculator.js
    participant H as history.js
    participant LS as LocalStorage

    Note over C,LS: 計算実行時（10 + 5 = 15）

    C->>C: calculate()
    C->>C: result = 15
    C->>C: 正常結果（Error/Infinityではない）

    C->>H: add({expression: "10 + 5", result: "15", mode: "standard"})

    H->>H: newEntry = {
    H->>H:   id: generateId(),
    H->>H:   expression: "10 + 5",
    H->>H:   result: "15",
    H->>H:   mode: "standard",
    H->>H:   timestamp: Date.now()
    H->>H: }

    H->>H: entries.unshift(newEntry)

    H->>H: entries.length > MAX_ENTRIES?
    alt 最大件数超過
        H->>H: entries.pop()
        Note over H: 最も古いエントリを削除
    end

    H->>LS: setItem("calc_history", JSON.stringify(entries))

    H->>H: render()
    Note over H: パネルが開いていれば表示を更新
```

---

## 8. シーケンス図（起動時の履歴読み込み）

```mermaid
sequenceDiagram
    participant M as main.js
    participant H as history.js
    participant LS as LocalStorage

    M->>H: init()

    H->>H: cacheElements()
    H->>H: DOM要素をキャッシュ

    H->>H: loadFromStorage()
    H->>LS: getItem("calc_history")

    alt データあり
        LS->>H: JSON文字列
        H->>H: JSON.parse()
        H->>H: Array.isArray() で検証
        H->>H: entries = parsed.slice(0, MAX_ENTRIES)
    else データなし or パースエラー
        H->>H: entries = []
    end

    H->>H: setupEventListeners()
    H->>H: render()
```

---

## 9. 処理フロー（履歴追加）

```
HistoryManager.add(entry)
    │
    ├─► newEntry = {
    │     id: generateId(),  ← タイムスタンプ + ランダム
    │     expression: entry.expression,
    │     result: entry.result,
    │     mode: entry.mode,
    │     timestamp: Date.now()
    │   }
    │
    ├─► entries.unshift(newEntry)  ← 先頭に追加
    │
    ├─► if (entries.length > MAX_ENTRIES)
    │     └─► entries.pop()  ← 末尾（最古）を削除
    │
    ├─► saveToStorage()
    │     └─► localStorage.setItem(...)
    │
    └─► render()  ← パネルが開いていれば更新
```

---

## 10. 日時表示フォーマット

```
formatTimestamp(timestamp)
    │
    ├─► 今日の場合
    │     └─► "14:30" (時:分のみ)
    │
    ├─► 今年の場合
    │     └─► "12月11日 14:30" (月日 + 時分)
    │
    └─► それ以外
          └─► "2025/12/11" (年月日)
```

---

## 11. エラーハンドリング

### 11.1 LocalStorage読み込みエラー

```mermaid
sequenceDiagram
    participant H as history.js
    participant LS as LocalStorage

    H->>LS: getItem("calc_history")
    LS->>H: 破損したデータ or 例外

    H->>H: catch(e)
    H->>H: console.error("Failed to load history:", e)
    H->>H: entries = []

    Note over H: 空の履歴として開始
```

### 11.2 クリップボードAPIエラー

```mermaid
sequenceDiagram
    participant H as history.js
    participant CB as Clipboard API
    participant D as DOM

    H->>CB: navigator.clipboard.writeText(value)
    CB->>H: Promise rejected (権限なし等)

    H->>H: catch(e)
    H->>H: フォールバック処理

    H->>D: textarea要素を作成
    H->>D: document.body.appendChild(textarea)
    H->>D: textarea.select()
    H->>D: document.execCommand("copy")
    H->>D: document.body.removeChild(textarea)
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | 初版作成 | Claude Code |
