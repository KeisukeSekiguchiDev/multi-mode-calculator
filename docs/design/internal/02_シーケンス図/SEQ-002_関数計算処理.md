# SEQ-002 関数計算処理シーケンス図

## 文書情報

| 項目 | 内容 |
|------|------|
| シーケンスID | SEQ-002 |
| 処理名 | 関数計算処理（三角関数・対数等） |
| 対応画面 | SCR-002（関数電卓） |
| 作成日 | 2025-12-11 |

---

## 1. 概要

関数電卓モードで三角関数、対数関数、累乗関数などを使用した計算フローを示す。

---

## 2. シーケンス図（sin関数）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant H as history.js

    Note over U,H: 前提: 関数電卓モード、角度モード=DEG

    U->>M: クリック: 数字ボタン "45"
    M->>C: inputNumber("4"), inputNumber("5")
    C->>C: currentValue = "45"
    C->>D: update()
    D->>D: updateMainDisplay("45")

    U->>M: クリック: ボタン "sin"
    M->>C: scientificOperation("sin")
    C->>C: value = 45
    C->>C: toRadians(45) → 0.7854rad (DEGモード変換)
    C->>C: Math.sin(0.7854) → 0.7071...
    C->>C: formatNumber() → "0.7071067812"
    C->>C: currentValue = "0.7071067812"
    C->>C: isResultDisplayed = true
    C->>D: update()
    D->>D: updateMainDisplay("0.7071067812")
    D->>D: updateAngleModeIndicator("DEG")
```

---

## 3. シーケンス図（対数関数）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    U->>M: クリック: 数字ボタン "100"
    M->>C: inputNumber("1"), inputNumber("0"), inputNumber("0")
    C->>C: currentValue = "100"
    C->>D: update()

    U->>M: クリック: ボタン "log"
    M->>C: scientificOperation("log")
    C->>C: value = 100
    C->>C: Math.log10(100) → 2
    C->>C: currentValue = "2"
    C->>D: update()
    D->>D: updateMainDisplay("2")
```

---

## 4. シーケンス図（累乗計算）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant H as history.js

    Note over U,H: 2^8を計算

    U->>M: クリック: 数字ボタン "2"
    M->>C: inputNumber("2")
    C->>C: currentValue = "2"
    C->>D: update()

    U->>M: クリック: ボタン "x^y"
    M->>C: inputOperator("^")
    C->>C: previousValue = 2
    C->>C: currentOperator = "^"
    C->>D: update()

    U->>M: クリック: 数字ボタン "8"
    M->>C: inputNumber("8")
    C->>C: currentValue = "8"
    C->>D: update()

    U->>M: クリック: ボタン "="
    M->>C: calculate()
    C->>C: Math.pow(2, 8) → 256
    C->>H: add({expression: "2 ^ 8", result: "256", mode: "scientific"})
    C->>C: currentValue = "256"
    C->>D: update()
    D->>D: updateMainDisplay("256")
```

---

## 5. シーケンス図（階乗計算）

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js

    U->>M: クリック: 数字ボタン "5"
    M->>C: inputNumber("5")
    C->>C: currentValue = "5"
    C->>D: update()

    U->>M: クリック: ボタン "n!"
    M->>C: scientificOperation("factorial")
    C->>C: value = 5
    C->>C: factorial(5) → 120
    C->>C: currentValue = "120"
    C->>D: update()
    D->>D: updateMainDisplay("120")
```

---

## 6. エラーケース

### 6.1 arcsinの定義域外

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: currentValue = "2" (|x| > 1)

    U->>C: scientificOperation("asin")
    C->>C: value = 2
    C->>C: |2| > 1 → 定義域外
    C->>C: setError("Error")
    C->>C: hasError = true
    C->>D: update()
    D->>D: updateMainDisplay("Error")
```

### 6.2 対数の定義域外

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: currentValue = "-5" (x ≤ 0)

    U->>C: scientificOperation("log")
    C->>C: value = -5
    C->>C: -5 <= 0 → 定義域外
    C->>C: setError("Error")
    C->>D: update()
    D->>D: updateMainDisplay("Error")
```

### 6.3 負の数の平方根

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: currentValue = "-4"

    U->>C: scientificOperation("sqrt")
    C->>C: value = -4
    C->>C: -4 < 0 → 虚数結果
    C->>C: setError("Error")
    C->>D: update()
    D->>D: updateMainDisplay("Error")
```

### 6.4 階乗オーバーフロー

```mermaid
sequenceDiagram
    participant U as User
    participant C as calculator.js
    participant D as display.js

    Note over U,D: currentValue = "171" (> MAX_FACTORIAL)

    U->>C: scientificOperation("factorial")
    C->>C: value = 171
    C->>C: 171 > 170 → オーバーフロー
    C->>C: result = Infinity
    C->>C: setError("Infinity")
    C->>D: update()
    D->>D: updateMainDisplay("Infinity")
```

---

## 7. 角度モード切替

```mermaid
sequenceDiagram
    participant U as User
    participant M as main.js
    participant C as calculator.js
    participant D as display.js
    participant LS as LocalStorage

    U->>M: クリック: "RAD"ボタン
    M->>C: setAngleMode("RAD")
    C->>C: angleMode = "RAD"
    C->>LS: setItem("calc_angleMode", "RAD")
    C->>D: update()
    D->>D: updateAngleModeIndicator("RAD")

    Note over U,LS: 以降の三角関数計算はラジアン入力として処理
```

---

## 8. 処理フロー（関数実行）

```
scientificOperation(func)
    │
    ├─► hasError? ─► return (エラー状態なら何もしない)
    │
    ├─► value = parseFloat(currentValue)
    │
    ├─► switch(func)
    │     ├─► sin/cos/tan: 角度変換 + Math.xxx()
    │     ├─► asin/acos: 定義域チェック + Math.xxx() + 角度変換
    │     ├─► log/ln: 定義域チェック + Math.xxx()
    │     ├─► sqrt: 負数チェック + Math.sqrt()
    │     ├─► factorial: 整数チェック + 上限チェック + 計算
    │     └─► その他...
    │
    ├─► isFinite(result)? ─► No → setError()
    │
    └─► 成功: currentValue = formatNumber(result)
              isResultDisplayed = true
              DisplayManager.update()
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 変更者 |
|------|------------|----------|--------|
| 2025-12-11 | 1.0 | 初版作成 | Claude Code |
